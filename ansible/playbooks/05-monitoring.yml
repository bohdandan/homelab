---
# Monitoring Stack Playbook (kube-prometheus-stack + Loki)

- name: Install Monitoring Stack
  hosts: k3s_master
  become: true
  gather_facts: true

  tasks:
    - name: Create monitoring namespace
      command: kubectl create namespace monitoring
      ignore_errors: yes

    - name: Add Prometheus Community Helm repo
      command: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

    - name: Add Grafana Helm repo
      command: helm repo add grafana https://grafana.github.io/helm-charts

    - name: Update Helm repos
      command: helm repo update

    - name: Install kube-prometheus-stack via Helm
      command: |
        helm upgrade --install kube-prometheus-stack prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --set prometheus.prometheusSpec.retention=30d \
          --set prometheus.prometheusSpec.storageSpec.volumeClaimTemplate.spec.resources.requests.storage=20Gi \
          --set grafana.adminPassword=admin \
          --set grafana.persistence.enabled=true \
          --set grafana.persistence.size=10Gi \
          --wait --timeout=10m

    - name: Install Loki via Helm
      command: |
        helm upgrade --install loki grafana/loki-stack \
          --namespace monitoring \
          --set loki.persistence.enabled=true \
          --set loki.persistence.size=10Gi \
          --set promtail.enabled=true \
          --wait

    - name: Wait for monitoring stack to be ready
      command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=grafana -n monitoring --timeout=300s

    - name: Get Grafana service
      command: kubectl get svc -n monitoring kube-prometheus-stack-grafana -o jsonpath='{.spec.clusterIP}'
      register: grafana_ip

    - name: Display monitoring info
      debug:
        msg: |
          âœ… Monitoring stack installed!
          Grafana: http://{{ grafana_ip.stdout }}:80 (admin/admin)
          Prometheus: kubectl port-forward -n monitoring svc/kube-prometheus-stack-prometheus 9090:9090

    - name: Verify monitoring pods
      command: kubectl get pods -n monitoring
      register: monitoring_pods

    - name: Display monitoring pods
      debug:
        var: monitoring_pods.stdout_lines
