---
# Networking Configuration Playbook (MetalLB + Ingress-NGINX)

- name: Install MetalLB
  hosts: k3s_master
  become: true
  gather_facts: true

  vars:
    metallb_version: v0.14.3
    # metallb_ip_range comes from k3s_cluster group vars in inventory

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    - name: Apply MetalLB manifest
      ansible.builtin.command: kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/config/manifests/metallb-native.yaml
      register: metallb_install

    - name: Wait for MetalLB controller to be ready
      ansible.builtin.command: kubectl wait --namespace metallb-system --for=condition=ready pod --selector=app=metallb --timeout=180s
      retries: 3
      delay: 10

    - name: Create MetalLB IPAddressPool
      ansible.builtin.copy:
        content: |
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: homelab-pool
            namespace: metallb-system
          spec:
            addresses:
            - {{ metallb_ip_range }}
        dest: /tmp/metallb-pool.yaml

    - name: Apply IPAddressPool
      ansible.builtin.command: kubectl apply -f /tmp/metallb-pool.yaml

    - name: Create MetalLB L2Advertisement
      ansible.builtin.copy:
        content: |
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
            name: homelab-l2
            namespace: metallb-system
          spec:
            ipAddressPools:
            - homelab-pool
        dest: /tmp/metallb-l2.yaml

    - name: Apply L2Advertisement
      ansible.builtin.command: kubectl apply -f /tmp/metallb-l2.yaml

    - name: Verify MetalLB installation
      ansible.builtin.command: kubectl get pods -n metallb-system
      register: metallb_pods

    - name: Display MetalLB pods
      ansible.builtin.debug:
        var: metallb_pods.stdout_lines

- name: Install Ingress-NGINX
  hosts: k3s_master
  become: true
  gather_facts: true

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    - name: Install Helm
      ansible.builtin.shell: |
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Add Ingress-NGINX Helm repo
      ansible.builtin.command: helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

    - name: Update Helm repos
      ansible.builtin.command: helm repo update

    - name: Install Ingress-NGINX via Helm
      ansible.builtin.shell: >
        helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx
        --namespace ingress-nginx
        --create-namespace
        --set controller.service.type=LoadBalancer
        --set controller.watchIngressWithoutClass=false
        --set controller.ingressClassResource.default=true
        --wait --timeout 5m
      register: ingress_install

    - name: Wait for Ingress-NGINX to get LoadBalancer IP
      ansible.builtin.shell: >
        kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: ingress_ip
      until: ingress_ip.stdout != ""
      retries: 30
      delay: 10

    - name: Display Ingress-NGINX LoadBalancer IP
      ansible.builtin.debug:
        msg: "Ingress-NGINX LoadBalancer IP: {{ ingress_ip.stdout }}"

    - name: Verify Ingress-NGINX installation
      ansible.builtin.command: kubectl get pods -n ingress-nginx
      register: ingress_pods

    - name: Display Ingress-NGINX pods
      ansible.builtin.debug:
        var: ingress_pods.stdout_lines
