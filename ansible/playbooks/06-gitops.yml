---
# GitOps Deployment Playbook (ArgoCD)

- name: Install ArgoCD
  hosts: k3s_master
  become: true
  gather_facts: true

  vars:
    argocd_version: v2.9.3

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    - name: Create argocd namespace
      ansible.builtin.command: kubectl create namespace argocd
      ignore_errors: true

    - name: Install ArgoCD
      ansible.builtin.command: >
        kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/install.yaml

    - name: Wait for ArgoCD server to be ready
      ansible.builtin.command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=300s
      retries: 3
      delay: 10

    - name: Patch ArgoCD server service to LoadBalancer
      ansible.builtin.shell: >
        kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "LoadBalancer"}}'

    - name: Wait for LoadBalancer IP
      ansible.builtin.shell: >
        kubectl get svc argocd-server -n argocd -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
      register: argocd_ip
      until: argocd_ip.stdout != ""
      retries: 30
      delay: 10

    - name: Get ArgoCD admin password
      ansible.builtin.shell: >
        kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
      register: argocd_password

    - name: Display ArgoCD access info
      ansible.builtin.debug:
        msg: |
          âœ… ArgoCD installed!
          URL: https://{{ argocd_ip.stdout }}
          Username: admin
          Password: {{ argocd_password.stdout }}

          Change password with: argocd account update-password

    - name: Create gitops directory for applications
      ansible.builtin.file:
        path: /home/ubuntu/gitops
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: "0755"

    - name: Display next steps
      ansible.builtin.debug:
        msg: |
          Next steps:
          1. Access ArgoCD UI at https://{{ argocd_ip.stdout }}
          2. Add your Git repository with homelab manifests
          3. Create ArgoCD Applications to deploy services
          4. See /home/ubuntu/gitops for example configurations
