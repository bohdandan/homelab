---
# Security Configuration Playbook (cert-manager)

- name: Install cert-manager
  hosts: k3s_master
  become: true
  gather_facts: true

  vars:
    cert_manager_version: v1.13.3

  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  tasks:
    - name: Create cert-manager namespace
      ansible.builtin.command: kubectl create namespace cert-manager
      ignore_errors: true

    - name: Install cert-manager CRDs
      ansible.builtin.command: >
        kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/{{ cert_manager_version }}/cert-manager.crds.yaml

    - name: Add Jetstack Helm repo
      ansible.builtin.command: helm repo add jetstack https://charts.jetstack.io

    - name: Update Helm repos
      ansible.builtin.command: helm repo update

    - name: Install cert-manager via Helm
      ansible.builtin.shell: >
        helm upgrade --install cert-manager jetstack/cert-manager
        --namespace cert-manager
        --version {{ cert_manager_version }}
        --wait --timeout 5m

    - name: Wait for cert-manager to be ready
      ansible.builtin.command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=cert-manager -n cert-manager --timeout=180s

    - name: Create self-signed ClusterIssuer
      ansible.builtin.copy:
        content: |
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: selfsigned-issuer
          spec:
            selfSigned: {}
        dest: /tmp/selfsigned-issuer.yaml

    - name: Apply self-signed ClusterIssuer
      ansible.builtin.command: kubectl apply -f /tmp/selfsigned-issuer.yaml

    - name: Create Let's Encrypt staging ClusterIssuer
      ansible.builtin.copy:
        content: |
          apiVersion: cert-manager.io/v1
          kind: ClusterIssuer
          metadata:
            name: letsencrypt-staging
          spec:
            acme:
              server: https://acme-staging-v02.api.letsencrypt.org/directory
              email: admin@homelab.local
              privateKeySecretRef:
                name: letsencrypt-staging
              solvers:
              - http01:
                  ingress:
                    class: nginx
        dest: /tmp/letsencrypt-staging.yaml

    - name: Apply Let's Encrypt staging issuer
      ansible.builtin.command: kubectl apply -f /tmp/letsencrypt-staging.yaml

    - name: Verify cert-manager installation
      ansible.builtin.command: kubectl get pods -n cert-manager
      register: cert_manager_pods

    - name: Display cert-manager pods
      ansible.builtin.debug:
        var: cert_manager_pods.stdout_lines

    - name: Verify ClusterIssuers
      ansible.builtin.command: kubectl get clusterissuers
      register: cluster_issuers

    - name: Display ClusterIssuers
      ansible.builtin.debug:
        var: cluster_issuers.stdout_lines
